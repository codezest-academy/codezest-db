// CodeZest Database Schema
// Single source of truth for all CodeZest microservices
// 
// Architecture: 5 microservices, 30 models, PostgreSQL + MongoDB
// Services: Auth, Learning, Payments, Notifications, Activity
//
// Design Principles:
// - SOLID principles applied
// - Repository pattern via Prisma
// - Schema namespacing for service boundaries
// - UUID primary keys for distributed systems
// - Soft deletes for data retention
// - Audit trails on all models

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTH SERVICE MODELS (auth.*)
// ============================================================================
// Owner: codezest-auth microservice
// Purpose: User authentication, authorization, profiles, sessions
// ============================================================================

/// Core user accounts with authentication
model User {
  id       String   @id @default(uuid())
  email    String   @unique
  password String? // Nullable for OAuth-only users
  
  // Name fields
  firstName String
  lastName  String
  userName  String? // Social-style display name (like @username)
  
  role     UserRole @default(USER)

  // Email verification
  emailVerified Boolean @default(false)

  // Account Security (Priority 1)
  isActive         Boolean   @default(true)
  isSuspended      Boolean   @default(false)
  suspendedAt      DateTime?
  suspendedReason  String?

  // Login Security (Priority 1)
  lastLoginAt      DateTime?
  lastLoginIp      String?
  loginAttempts    Int       @default(0)
  lockedUntil      DateTime?

  // Password Management (Priority 1)
  passwordChangedAt  DateTime?
  mustChangePassword Boolean   @default(false)

  // 2FA/MFA Support (Priority 2)
  twoFactorEnabled Boolean  @default(false)
  twoFactorSecret  String? // Encrypted TOTP secret
  backupCodes      String[] // Encrypted backup codes

  // Username (Priority 2)
  username String? @unique

  // Email Preferences (Priority 2)
  emailNotifications Boolean @default(true)
  marketingEmails    Boolean @default(false)

  // Relationships
  profile            UserProfile?
  sessions           Session[]
  oauthAccounts      OAuthAccount[]
  passwordResets     PasswordReset[]
  emailVerifications EmailVerification[]
  emailChanges       EmailChange[]
  loginHistory       LoginHistory[]
  certificates       Certificate[]
  notificationSettings UserNotificationSetting[]
  devices              UserDevice[]

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  @@index([email])
  @@index([role])
  @@index([isActive])
  @@index([isSuspended])
  @@index([twoFactorEnabled])
  @@index([username])
  @@index([emailNotifications])
  @@map("auth.users")
}

/// Extended user profile information
model UserProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // ============================================================================
  // BASIC INFO (Normalized - Used for Display & Search)
  // ============================================================================
  displayName String?  // Public display name
  bio         String?  // Short bio (max 500 chars)
  avatar      String?  // Profile picture URL
  coverImage  String?  // Cover/banner image URL
  
  phone    String?
  location String?  // City, Country
  timezone String?  // For scheduling
  website  String?
  
  // ============================================================================
  // EDUCATIONAL BACKGROUND (Hybrid)
  // ============================================================================
  
  // Normalized - For Queries & Filtering
  educationLevel String?  // "high_school", "undergraduate", "graduate", "postgraduate"
  fieldOfStudy   String?  // "Computer Science", "Business", "Engineering"
  institution    String?  // Current/most recent institution
  graduationYear Int?     // Expected or actual
  
  // JSON - Full History (Display Only)
  education Json?
  // [{ degree: "BS", field: "CS", institution: "MIT", startYear: 2018, endYear: 2022, gpa: 3.8 }]
  
  // ============================================================================
  // PROFESSIONAL DETAILS (Hybrid)
  // ============================================================================
  
  // Normalized - For Queries & Recommendations
  currentRole     String?  // "Software Engineer", "Student", "Data Analyst"
  currentCompany  String?  // Company name
  industry        String?  // "Technology", "Finance", "Healthcare"
  experienceLevel String?  // "entry", "mid", "senior", "executive"
  yearsExperience Int?     // Total years
  
  // JSON - Full History (Display Only)
  workExperience Json?
  // [{ title: "Senior Dev", company: "Tech Corp", startDate: "2020-01", endDate: "2023-12", description: "...", skills: ["Python", "React"] }]
  
  // ============================================================================
  // LEARNING GOALS & MOTIVATIONS (Hybrid)
  // ============================================================================
  
  // Normalized - For Course Recommendations
  learningGoal String?  // "career_change", "skill_upgrade", "certification", "hobby", "academic"
  targetRole   String?  // Desired job title
  weeklyHours  Int?     // Hours available per week
  
  // JSON - Detailed Info (Display Only)
  interests   Json?  // ["web_development", "data_science", "machine_learning"]
  motivations Json?  // { primary: "Get better job", secondary: "Learn new skills", timeline: "6 months" }
  
  // ============================================================================
  // SKILLS & EXPERTISE (JSON - Display Only)
  // ============================================================================
  skills         Json?  // [{ name: "Python", level: "advanced", yearsExperience: 5 }]
  certifications Json?  // [{ name: "AWS Certified", issuer: "Amazon", issueDate: "2023-06", credentialId: "ABC123" }]
  
  // ============================================================================
  // LEARNING PREFERENCES (JSON - Settings)
  // ============================================================================
  learningStyle String?  // "visual", "auditory", "kinesthetic", "reading"
  studyTime     String?  // "morning", "afternoon", "evening", "night"
  
  preferences Json?  // { theme: "dark", language: "en", emailDigest: true, difficulty: "intermediate", subtitles: true, playbackSpeed: 1.5 }
  
  // ============================================================================
  // SOCIAL & NETWORKING (JSON - Display Only)
  // ============================================================================
  socials Json?  // { github: "username", linkedin: "username", twitter: "handle", portfolio: "https://..." }
  
  // Privacy Settings (Normalized - For Access Control)
  isPublic         Boolean @default(false)
  showEmail        Boolean @default(false)
  showProgress     Boolean @default(true)
  allowMessages    Boolean @default(true)
  showCertificates Boolean @default(true)
  
  // ============================================================================
  // ENGAGEMENT & ACTIVITY (Normalized - For Analytics)
  // ============================================================================
  onboardingCompleted Boolean   @default(false)
  onboardingStep      Int       @default(0)
  lastActiveAt        DateTime?
  
  totalLearningHours Int @default(0)
  coursesCompleted   Int @default(0)
  certificatesEarned Int @default(0)
  
  // Gamification (Normalized - For Leaderboards)
  points        Int @default(0)
  level         Int @default(1)
  streak        Int @default(0)  // Days in a row
  longestStreak Int @default(0)
  
  // ============================================================================
  // MINI-CRM FIELDS (Normalized - For Business Intelligence)
  // ============================================================================
  leadScore       Int       @default(0)   // 0-100
  leadStatus      String?   // "new", "engaged", "qualified", "converted"
  emailOpens      Int       @default(0)
  emailClicks     Int       @default(0)
  lastEmailSent   DateTime?
  lastEmailOpened DateTime?
  
  utmSource    String?  // Marketing attribution
  utmMedium    String?
  utmCampaign  String?
  referralCode String?
  
  segment       String?  // "beginner", "career_changer", "professional"
  internalNotes String?  // Admin notes (not visible to user)
  
  // JSON - Flexible Tagging
  tags Json?  // ["premium_prospect", "active_learner", "at_risk"]
  
  // ============================================================================
  // TIMESTAMPS
  // ============================================================================
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ============================================================================
  // INDEXES (On Normalized Fields Only)
  // ============================================================================
  @@index([userId])
  @@index([isPublic])
  @@index([educationLevel])
  @@index([fieldOfStudy])
  @@index([currentRole])
  @@index([industry])
  @@index([learningGoal])
  @@index([leadStatus])
  @@index([segment])
  @@index([lastActiveAt])
  @@index([onboardingCompleted])
  @@map("auth.user_profiles")
}

/// Active user sessions for JWT tracking
model Session {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?

  // Session Revocation (Priority 1)
  revokedAt DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([revokedAt])
  @@map("auth.sessions")
}

/// OAuth provider accounts (Google, GitHub, etc.)
model OAuthAccount {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  provider   String // "google", "github", "linkedin"
  providerId String // ID from OAuth provider

  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, providerId])
  @@index([userId])
  @@map("auth.oauth_accounts")
}

/// Password reset tokens
model PasswordReset {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  token     String    @unique
  expiresAt DateTime
  used      Boolean   @default(false)
  usedAt    DateTime?

  // Security Tracking (Priority 1)
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("auth.password_resets")
}

/// Email verification tokens
model EmailVerification {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  token      String    @unique
  verified   Boolean   @default(false)
  verifiedAt DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("auth.email_verifications")
}

/// Email change requests with verification
model EmailChange {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  oldEmail String
  newEmail String
  token    String   @unique
  verified Boolean  @default(false)
  expiresAt DateTime

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("auth.email_changes")
}

/// Login history for security audit trail
model LoginHistory {
  id String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  success   Boolean
  ipAddress String?
  userAgent String?
  location  String?  // Geo-location from IP

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("auth.login_history")
}

// ============================================================================
// LEARNING SERVICE MODELS (learning.*)
// ============================================================================
// Owner: codezest-api microservice
// Purpose: Programming languages, modules, materials, assignments, quizzes
// ============================================================================

/// Programming languages (Python, JavaScript, Java, etc.)
model ProgrammingLanguage {
  id          String     @id @default(uuid())
  name        String     @unique // "Python", "JavaScript", "Java"
  slug        String     @unique // "python", "javascript", "java"
  description String?
  icon        String? // URL or emoji
  difficulty  Difficulty @default(BEGINNER)
  isActive    Boolean    @default(true)

  // Relationships
  modules      Module[]
  enrollments  LanguageEnrollment[]
  certificates Certificate[]

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([slug])
  @@index([isActive])
  @@map("learning.programming_languages")
}

/// Learning modules within each programming language
model Module {
  id         String              @id @default(uuid())
  languageId String
  language   ProgrammingLanguage @relation(fields: [languageId], references: [id], onDelete: Cascade)

  title       String // "Python Basics", "Python OOP"
  slug        String // "python-basics"
  description String?
  syllabus    String? // JSON or text describing what's covered
  order       Int // Display order
  
  // NEW: Estimated Duration
  estimatedDuration Int? // Total minutes to complete entire module
  
  // NEW: Prerequisites (self-referential many-to-many)
  prerequisites Module[] @relation("ModulePrerequisites")
  dependents    Module[] @relation("ModulePrerequisites")

  // Relationships
  materials    Material[]
  assignments  Assignment[]
  mcqQuizzes   MCQQuiz[]
  progress     ModuleProgress[]
  certificates Certificate[]

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([languageId, slug])
  @@index([languageId])
  @@index([order])
  @@map("learning.modules")
}

/// Learning materials (videos, articles, code examples)
model Material {
  id       String @id @default(uuid())
  moduleId String
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  title    String
  type     MaterialType // VIDEO, ARTICLE, CODE_EXAMPLE, INTERACTIVE
  content  String // URL for video, markdown for article, code for examples
  duration Int? // minutes for video
  order    Int

  // Relationships
  progress MaterialProgress[]

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([moduleId])
  @@index([type])
  @@index([order])
  @@map("learning.materials")
}

/// Coding assignments with test cases
model Assignment {
  id       String @id @default(uuid())
  moduleId String
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  title       String
  description String
  difficulty  Difficulty

  starterCode String? // Initial code template
  testCases   String // JSON array of test cases
  hints       String? // JSON array of hints

  maxScore  Int  @default(100)
  timeLimit Int? // minutes
  
  // NEW: Estimated Duration
  estimatedDuration Int? // Expected completion time (different from timeLimit)

  // Relationships
  submissions AssignmentSubmission[]

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([moduleId])
  @@index([difficulty])
  @@map("learning.assignments")
}

/// User assignment submissions
model AssignmentSubmission {
  id           String     @id @default(uuid())
  userId       String
  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  code     String // User's submitted code
  language String // "python", "javascript"
  status   SubmissionStatus @default(PENDING)
  score    Int?
  feedback String? // Auto-generated or instructor feedback

  // Relationships
  analysis AssignmentAnalysis?

  // Timestamps
  submittedAt DateTime  @default(now())
  gradedAt    DateTime?

  @@index([userId])
  @@index([assignmentId])
  @@index([status])
  @@map("learning.assignment_submissions")
}

/// MCQ quizzes for assessment
model MCQQuiz {
  id       String @id @default(uuid())
  moduleId String
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  title        String
  description  String?
  passingScore Int     @default(70)
  timeLimit    Int? // minutes
  
  // NEW: Estimated Duration
  estimatedDuration Int? // Expected completion time (different from timeLimit)

  // Relationships
  questions MCQQuestion[]
  attempts  MCQAttempt[]

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([moduleId])
  @@map("learning.mcq_quizzes")
}

/// MCQ quiz questions
model MCQQuestion {
  id     String  @id @default(uuid())
  quizId String
  quiz   MCQQuiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  question    String
  explanation String? // Shown after answering
  order       Int
  points      Int     @default(1)

  // Relationships
  options MCQOption[]
  answers MCQAnswer[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([quizId])
  @@index([order])
  @@map("learning.mcq_questions")
}

/// MCQ answer options
model MCQOption {
  id         String      @id @default(uuid())
  questionId String
  question   MCQQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  optionText String
  isCorrect  Boolean
  order      Int

  // Relationships
  selectedBy MCQAnswer[]

  @@index([questionId])
  @@map("learning.mcq_options")
}

/// User language enrollments
model LanguageEnrollment {
  id         String              @id @default(uuid())
  userId     String
  languageId String
  language   ProgrammingLanguage @relation(fields: [languageId], references: [id], onDelete: Cascade)

  status EnrollmentStatus @default(ACTIVE)

  enrolledAt  DateTime  @default(now())
  completedAt DateTime?

  @@unique([userId, languageId])
  @@index([userId])
  @@index([languageId])
  @@index([status])
  @@map("learning.language_enrollments")
}

/// Module progress tracking
model ModuleProgress {
  id       String @id @default(uuid())
  userId   String
  moduleId String
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  status          ProgressStatus @default(NOT_STARTED)
  progressPercent Int            @default(0) // 0-100

  startedAt      DateTime?
  completedAt    DateTime?
  lastAccessedAt DateTime  @default(now())

  @@unique([userId, moduleId])
  @@index([userId])
  @@index([moduleId])
  @@index([status])
  @@map("learning.module_progress")
}

/// Material view tracking
model MaterialProgress {
  id         String   @id @default(uuid())
  userId     String
  materialId String
  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  completed Boolean @default(false)
  viewCount Int     @default(0)

  lastViewedAt DateTime  @default(now())
  completedAt  DateTime?

  @@unique([userId, materialId])
  @@index([userId])
  @@index([materialId])
  @@index([completed])
  @@map("learning.material_progress")
}

/// Quiz attempts
model MCQAttempt {
  id     String  @id @default(uuid())
  userId String
  quizId String
  quiz   MCQQuiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  score Int?

  // Relationships
  answers  MCQAnswer[]
  analysis QuizAnalysis?

  // Timestamps
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([userId])
  @@index([quizId])
  @@map("learning.mcq_attempts")
}

/// Individual MCQ answers
model MCQAnswer {
  id               String      @id @default(uuid())
  attemptId        String
  attempt          MCQAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  questionId       String
  question         MCQQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  selectedOptionId String?
  selectedOption   MCQOption?  @relation(fields: [selectedOptionId], references: [id], onDelete: SetNull)

  isCorrect Boolean

  answeredAt DateTime @default(now())

  @@index([attemptId])
  @@index([questionId])
  @@map("learning.mcq_answers")
}

/// AI/Manual analysis of assignment submissions
model AssignmentAnalysis {
  id           String               @id @default(uuid())
  submissionId String               @unique
  submission   AssignmentSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  analysisType AnalysisType @default(AI)

  // Analysis results
  overallScore Int? // 0-100

  // Detailed feedback
  strengths   String[] // Array of strengths
  weaknesses  String[] // Array of weaknesses
  suggestions String[] // Improvement suggestions

  // Code quality metrics (JSONB)
  codeQuality Json? // { readability: 8, efficiency: 7, bestPractices: 9 }

  // Detailed breakdown
  detailedFeedback String?

  // AI metadata
  aiModel  String? // "gpt-4", "claude-3", etc.
  aiPrompt String? // Prompt used for AI analysis

  // Manual analysis
  analyzedBy String? // userId of instructor (if manual)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([submissionId])
  @@index([analysisType])
  @@map("learning.assignment_analyses")
}

/// AI/Manual analysis of quiz attempts
model QuizAnalysis {
  id        String     @id @default(uuid())
  attemptId String     @unique
  attempt   MCQAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  analysisType AnalysisType @default(AI)

  // Performance breakdown (JSONB)
  performanceBreakdown Json // { "Python Basics": 80, "Functions": 90, "Loops": 70 }

  // Strengths and weaknesses
  strongTopics String[] // Topics user excels at
  weakTopics   String[] // Topics needing improvement

  // Recommendations
  recommendations String[] // Personalized study recommendations

  // Insights
  insights String? // AI-generated insights

  // Time analysis
  avgTimePerQuestion Int? // Average seconds per question
  timeManagement     String? // "Good", "Needs improvement", etc.

  // AI metadata
  aiModel String?

  // Manual analysis
  analyzedBy String? // userId of instructor

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([attemptId])
  @@index([analysisType])
  @@map("learning.quiz_analyses")
}

/// Certificates for course/module completion
model Certificate {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Certificate Type
  type String // "completion", "achievement", "mastery"
  
  // What was completed
  languageId String?
  moduleId   String?
  language   ProgrammingLanguage? @relation(fields: [languageId], references: [id], onDelete: SetNull)
  module     Module?              @relation(fields: [moduleId], references: [id], onDelete: SetNull)
  
  // Certificate Details
  title          String  // "Python Programming Certificate"
  description    String? // "Completed Python Basics and OOP"
  certificateUrl String? // PDF URL (generated)
  credentialId   String  @unique // Unique verification code
  
  // Verification
  isVerified Boolean @default(false)
  verifiedBy String? // Admin who verified
  
  // Metadata
  score Int? // Final score if applicable
  grade String? // "A", "B", "C" or "Pass", "Distinction"
  
  // Timestamps
  issuedAt  DateTime  @default(now())
  expiresAt DateTime? // Some certificates expire
  
  @@index([userId])
  @@index([credentialId])
  @@index([languageId])
  @@index([moduleId])
  @@index([type])
  @@map("learning.certificates")
}

// ============================================================================
// PAYMENT SERVICE MODELS (payments.*)
// ============================================================================
// Owner: codezest-payments microservice
// Purpose: Subscriptions, transactions, invoices, payment methods
// ============================================================================

/// User subscriptions (FREE/PRO/ENTERPRISE)
model Subscription {
  id     String @id @default(uuid())
  userId String @unique

  plan   SubscriptionPlan   @default(FREE)
  status SubscriptionStatus @default(ACTIVE)

  // Stripe integration
  stripeCustomerId     String? @unique
  stripeSubscriptionId String? @unique

  // Validity
  startedAt  DateTime  @default(now())
  validUntil DateTime? // null for FREE plan = lifetime access
  canceledAt DateTime?

  // Relationships
  transactions Transaction[]
  invoices     Invoice[]

  // Metadata (JSONB for flexibility)
  metadata Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([plan])
  @@index([status])
  @@map("payments.subscriptions")
}

/// Payment transactions
model Transaction {
  id             String        @id @default(uuid())
  userId         String
  subscriptionId String?
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  amount   Int    @default(0) // Amount in cents (e.g., 999 = $9.99)
  currency String @default("usd")

  status TransactionStatus @default(PENDING)

  // Stripe integration
  stripePaymentIntentId String? @unique
  stripeChargeId        String? @unique

  // Payment details
  paymentMethod String? // "card", "paypal", etc.
  description   String?

  // Timestamps
  createdAt DateTime  @default(now())
  paidAt    DateTime?
  failedAt  DateTime?

  @@index([userId])
  @@index([subscriptionId])
  @@index([status])
  @@map("payments.transactions")
}

/// Generated invoices
model Invoice {
  id             String       @id @default(uuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  invoiceNumber String @unique // INV-2025-001

  amount   Int    @default(0) // Amount in cents
  currency String @default("usd")
  tax      Int? // Tax amount in cents
  total    Int    @default(0) // Total amount including tax

  status InvoiceStatus @default(DRAFT)

  // Stripe
  stripeInvoiceId String? @unique
  invoiceUrl      String? // PDF URL

  // Dates
  issuedAt DateTime  @default(now())
  dueAt    DateTime?
  paidAt   DateTime?

  @@index([subscriptionId])
  @@index([status])
  @@index([invoiceNumber])
  @@map("payments.invoices")
}

/// Saved payment methods
model PaymentMethod {
  id     String @id @default(uuid())
  userId String

  type PaymentMethodType

  // Stripe
  stripePaymentMethodId String? @unique

  // Card details (last 4 digits, brand)
  last4       String?
  brand       String? // "visa", "mastercard", etc.
  expiryMonth Int?
  expiryYear  Int?

  // PayPal
  paypalEmail String?

  isDefault Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isDefault])
  @@map("payments.payment_methods")
}

// ============================================================================
// NOTIFICATION SERVICE MODELS (notifications.*)
// ============================================================================
// Owner: codezest-notifications microservice
// Purpose: User notifications, preferences, email logs
// ============================================================================

/// Notification types (System-wide configuration)
model NotificationType {
  id          String   @id @default(uuid())
  name        String   @unique // e.g., "assignment_graded"
  slug        String   @unique // e.g., "assignment-graded"
  category    String   // "learning", "account", "marketing"
  description String?
  
  // Default Channels
  emailEnabled Boolean @default(true)
  pushEnabled  Boolean @default(true)
  smsEnabled   Boolean @default(false)
  inAppEnabled Boolean @default(true)
  
  // Templates (Optional)
  emailTemplateId String?
  pushTemplateId  String?
  
  // Relationships
  settings      UserNotificationSetting[]
  notifications Notification[]
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("notifications.notification_types")
}

/// User notification settings (Granular preferences)
model UserNotificationSetting {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  typeId String
  type   NotificationType @relation(fields: [typeId], references: [id], onDelete: Cascade)
  
  // Overrides (Null = use default from NotificationType)
  email Boolean?
  push  Boolean?
  sms   Boolean?
  inApp Boolean?
  
  updatedAt DateTime @updatedAt
  
  @@unique([userId, typeId])
  @@map("notifications.user_settings")
}

/// User devices for push notifications
model UserDevice {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token    String @unique // FCM/APNS token
  platform String // "ios", "android", "web"
  model    String? // "iPhone 15", "Pixel 8"
  
  isActive   Boolean @default(true)
  lastUsedAt DateTime @default(now())
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@map("notifications.user_devices")
}

/// User notifications (Enhanced)
model Notification {
  id     String @id @default(uuid())
  userId String
  // user   User   @relation(fields: [userId], references: [id], onDelete: Cascade) // Defined in User model

  // Link to type
  typeId String
  type   NotificationType @relation(fields: [typeId], references: [id])
  
  title    String
  message  String
  data     Json?    // Dynamic data for navigation/logic
  priority String   @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  
  // Status
  isRead   Boolean   @default(false)
  readAt   DateTime?
  isSeen   Boolean   @default(false) // Seen in dropdown but not clicked
  
  // Action tracking
  actionUrl String?
  
  // Timestamps
  createdAt DateTime @default(now())
  expiresAt DateTime? // Auto-cleanup

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications.notifications")
}

/// Email delivery logs
model EmailLog {
  id String @id @default(uuid())

  to      String
  from    String @default("noreply@codezest.com")
  subject String
  body    String

  status String @default("PENDING") // PENDING, SENT, FAILED, BOUNCED

  // Email service metadata
  provider   String? // "sendgrid", "ses", "resend"
  providerId String? // ID from email service

  // Timestamps
  createdAt DateTime  @default(now())
  sentAt    DateTime?
  failedAt  DateTime?

  @@index([to])
  @@index([status])
  @@index([createdAt])
  @@map("notifications.email_logs")
}

// ============================================================================
// ACTIVITY SERVICE MODELS (activity.*)
// ============================================================================
// Owner: codezest-activity microservice
// Purpose: Activity feeds, analytics events
// ============================================================================

/// User activity feed events
model UserActivity {
  id     String @id @default(uuid())
  userId String

  type        String // "module_started", "assignment_submitted", "quiz_completed"
  description String

  // Metadata (JSONB)
  metadata Json? // { moduleId, score, etc. }

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("activity.user_activities")
}

/// Custom analytics events
model AnalyticsEvent {
  id String @id @default(uuid())

  eventName String
  userId    String?

  // Event properties (JSONB)
  properties Json? // Flexible event data

  createdAt DateTime @default(now())

  @@index([eventName])
  @@index([userId])
  @@index([createdAt])
  @@map("activity.analytics_events")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  USER
  ADMIN
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum MaterialType {
  VIDEO
  ARTICLE
  CODE_EXAMPLE
  INTERACTIVE
}

enum SubmissionStatus {
  PENDING
  RUNNING
  PASSED
  FAILED
  ERROR
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum EnrollmentStatus {
  ACTIVE
  PAUSED
  COMPLETED
  DROPPED
}

enum SubscriptionPlan {
  FREE
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
  PAUSED
}

enum TransactionStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELED
}

enum PaymentMethodType {
  CARD
  PAYPAL
  BANK_TRANSFER
}

enum AnalysisType {
  AI
  MANUAL
  HYBRID
}
